---
title: Android全屏切换
date: 2019-01-07 14:14:33
category: Android
tags: 
    - Android
---

Android Framework 中很多地方使用了标志位，`View` 的 `SystemUiVisibility` 就是一种，虽然只是一个 `Int` 类型，但是转换成二进制，每一位都可以做一个开关。

添加一个标志：

``` kotlin
uiOptions = uiOptions or View.SYSTEM_UI_FLAG_LOW_PROFILE
```

移除一个标志：

``` kotlin
uiOptions = uiOptions and View.SYSTEM_UI_FLAG_LOW_PROFILE.inv()
```

视频播放进入全屏，要隐藏状态栏，Actionbar，导航栏。需要注意的是全屏和横竖屏切换是两个独立的东西。

其实在 Android 上没有一个全屏的 Api，做全屏的功能需要一列的操作进行组合，而且要考虑版本的兼容。

首先，有 Actionbar 的话要隐藏：

``` kotlin
if (activity is AppCompatActivity) {
    activity.supportActionBar?.hide()
} else {
    activity.actionBar?.hide()
}
```

然后我们开始设置 `systemUiVisibility`

``` kotlin
var uiOptions = activity.window.decorView.systemUiVisibility

uiOptions = uiOptions or View.SYSTEM_UI_FLAG_LOW_PROFILE
uiOptions = uiOptions or View.SYSTEM_UI_FLAG_FULLSCREEN
uiOptions = uiOptions or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION

if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE
    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
}

activity.window.decorView.systemUiVisibility = uiOptions
```

为了兼容低版本，还要设置 window 的 flag

``` kotlin
val attrs = activity.window.attributes
attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_FULLSCREEN
attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON
activity.window.attributes = attrs
```

要退出全屏，把进入全屏时的设置全部清除就可以了，最终的代码为：

``` kotlin
fun enterFullScreen(activity: Activity) {

    if (activity is AppCompatActivity) {
        activity.supportActionBar?.hide()
    } else {
        activity.actionBar?.hide()
    }

    val attrs = activity.window.attributes
    attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_FULLSCREEN
    attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON
    activity.window.attributes = attrs

    var uiOptions = activity.window.decorView.systemUiVisibility

    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_LOW_PROFILE
    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_FULLSCREEN
    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION

    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
        uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE
        uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
    }

    activity.window.decorView.systemUiVisibility = uiOptions
}

fun existFullScreen(activity: Activity) {
    if (activity is AppCompatActivity) {
        activity.supportActionBar?.show()
    } else {
        activity.actionBar?.show()
    }

    val attrs = activity.window.attributes
    attrs.flags = attrs.flags and WindowManager.LayoutParams.FLAG_FULLSCREEN.inv()
    attrs.flags = attrs.flags and WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON.inv()
    activity.window.attributes = attrs

    var uiOptions = activity.window.decorView.systemUiVisibility

    uiOptions = uiOptions and View.SYSTEM_UI_FLAG_LOW_PROFILE.inv()
    uiOptions = uiOptions and View.SYSTEM_UI_FLAG_FULLSCREEN.inv()
    uiOptions = uiOptions and View.SYSTEM_UI_FLAG_HIDE_NAVIGATION.inv()


    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
        uiOptions = uiOptions and View.SYSTEM_UI_FLAG_IMMERSIVE.inv()
        uiOptions = uiOptions and View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY.inv()
    }

    activity.window.decorView.systemUiVisibility = uiOptions
}
```