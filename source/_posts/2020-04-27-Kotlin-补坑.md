---
title: Kotlin 补坑
date: 2020-04-27 11:50:37
category: Kotlin
tags: 
    - Kotlin
---

Kotlin 的 Iterable 遍历基本上都是使用 forEach，在 for 语句中可以方便的使用 break 跳出循环，但是 forEach 代码块中不能使用 break，之前一直以为使用 `return@forEach` 能够跳出遍历，起到和 break 一样的作用，其实这是非常错误的，`return@forEach` 只能跳出本次 forEach 的代码块，相当于 continue。

究其原因，先看 forEach 的函数声明：

``` kotlin
public inline fun <T> Iterable<T>.forEach(action: (T) -> Unit): Unit {
    for (element in this) action(element)
}
```

forEach 是一个 inline 函数，action 是一个高阶函数，*Kotlin的 return 只能返回具名函数或者匿名函数，并且在 Lambda 表达式内禁止使用 return*，但是如果 Lambda 表达式是内敛的，return 也可以内敛，那么就可以使用 return，不过这个 return 也只能跳出具名函数或者匿名函数，要跳出 Lambda，需要使用 return 加标签的形式，也就是 `return@forEach` 的形式，例如：

``` kotlin
fun main() {
    listOf(1, 2, 3, 4, 5).forEach {
        if (it == 3) {
            return@forEach
        }
        println(it)
    }
}
```

`return@forEach` 的标签 forEach 是编译器自动生成的，有一定的误导性，如果我们自己加标签的话就是：

``` kotlin
fun main() {
    listOf(1, 2, 3, 4, 5).forEach action@{
        if (it == 3) {
            return@action
        }
        println(it)
    }
}
```

`return@action` 跳出的是 `inline fun <T> Iterable<T>.forEach(action: (T) -> Unit): Unit` 的 action 的 匿名函数，如果把 action 单独声明，就更加明了：

``` kotlin
fun main() {
    val action = fun(item: Int) {
        if (item == 3) {
            return
        }
        println(item)
    }
    listOf(1, 2, 3, 4, 5).forEach(action)
}
```

action 中的 return 是结束本次的匿名函数，是不可能跳出 forEach 遍历的。

如果先结束遍历，可以再外层添加一个匿名函数，用 return加 Label 来返回这个函数

``` kotlin
run {
    listOf(1, 2, 3, 4, 5).forEach action@{
        if (it == 3) {
            return@run
        }
        println(it)
    }
}
```
