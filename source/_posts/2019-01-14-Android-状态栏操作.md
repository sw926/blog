---
title: Android 状态栏操作
date: 2019-01-14 11:59:01
category: Android
tags: 
    - Android
---

实际开发中 Android 状态栏遇到很多问题，为了 App 稳定性，就简单的使用了黑色状态栏，遇到的关于状态栏的问题有：
 
 - 不同 Android 版本的显示问题，4.4 一下不可修改，4.4是半透明，5.0及以上可以全透明
 - 状态栏背景修改
 - 状态改变后界面错乱，例如一个 View 是显示在状态栏下面的，切换到另外一个 View 后状态栏颜色改变了
 - 显示隐藏状态或者修改状态栏背景后界面会闪一下
 
业务需求方面：

 - Splash 页要求状态栏隐藏或者透明，进入主页后状态栏改变
 - Pager 之前切换状态栏改变
 - 新的页面状态栏改变，返回后状态栏恢复
 - 同一个 View 内状态栏动态改变，例如滑动的时候
 - 等等

网上很多文章都是是 Theme 修改状态，这个方法是可行的，但是仅靠 Theme 是不够的，有很多需求都是需要动态改变的状态栏的，我希望能达到的效果是尽量使用代码来实现，不调用系统的私有 Api，不使用反射，同时尽量满足产品需求。

首先是程序的闪屏页，从 App 启动到 `LAUNCHER Activity` 的 `onCreate` 这段时间，用户看到的是一个空白的页面，系统会加载 `window` 的背景，还没有到加载 `xml` 的 `layout` 的阶段，这时我们能做的：
 
 - 控制导航栏，隐藏或者透明
 - 控制状态栏，隐藏或者透明（半透明），高版本修改背景或者文字颜色
 - 修改 window background
 - 不让界面显示，效果就是点击 App 图标后没有任何反应，直到 `LAUNCHER Activity` 的 `onCreate` 

为了测试，在 `MainActivity` 的 `setContentView` 之前添加 `Thread.sleep(3000)` ，也可以添加到 `Application` `onCreate` 里面，模拟 App 启动时间为 3 秒：

``` kotlin
override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    Thread.sleep(3000)
    setContentView(R.layout.activity_main)
}
```

App 启动效果如下：

![image](./images/status_bar_1.gif)

`Window` 区域是白屏，如果希望将白屏设置为一个图片，可以修改 `theme` ，首先添加 style:

``` xml
<style name="AppTheme.Splash">
    <item name="android:windowBackground">@drawable/splash_background</item>
</style>
```

修改 Application 的 `theme` 为 `AppTheme.Splash`，

``` xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.sw926.toolkitdemo">

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/AppTheme">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <activity android:name=".TransStatsActivity"></activity>
    </application>

</manifest>
```

这样整个 App 的默认 `Window` 背景都修改了，所以需要在 `Activit` 的 `onCreate` 里面将 `theme` 改回来：

``` kotlin
override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    Thread.sleep(3000)
    setTheme(R.style.AppTheme)
    setContentView(R.layout.activity_main)
}
```

这时启动画面就不是空白了：

![image](./images/status_bar_2.gif)

接下来优化启动画面，主要做一下几点优化：
 
 - 状态栏：首先透明，不能透明就隐藏
 - 导航栏：只能透明，在 theme 中是不能隐藏导航栏的

关于导航栏和状态栏，在 theme 资源文件中：

 - 4.4 以下版本可以隐藏状态栏
 - 4.4 版本可以设置状态栏和导航栏为渐进的半透明
 - 5.0 及以上版本可以修改导航栏和状态栏的背景颜色
 - 6.0 及以上版本可以设置状态栏为 light 或者 dark，算是一种修改状态栏文本颜色的方法

在 4.4 以下版本的手机中，只能控制状态栏的显示和隐藏：

``` xml
<style name="AppTheme.TransStats">
    <item name="android:windowFullscreen">true</item>
</style>
```
 
`android:windowFullscreen` 为 `true` 的时候隐藏状态栏

在 4.1 模拟器上的效果为:

<img src="./images/4_1.png" width="30%" height="30%">

在 4.4 版本的手机上，可以状态栏和导航栏半透明渐变，需要在 `res` 文件夹下新建一个 `values-v19` 文件夹，添加以下的 style：

``` xml
<style name="AppTheme.TransStats">
    <item name="android:windowFullscreen">false</item>
    <item name="android:windowTranslucentStatus">true</item>
    <item name="android:windowTranslucentNavigation">true</item>
</style>
```

这个配置相当于覆盖 4.4 以下的 `AppTheme.TransStats`，在 4.4 上的效果为：

<img src="./images/4_4.png" width="30%" height="30%">

在 5.0 及以上的手机上，我们需要新建 `res/values-v21`，作用同样是覆盖低版本的 `AppTheme.TransStats`，

``` xml
<style name="AppTheme.TransStats">

    <item name="android:windowFullscreen">false</item>

    <!--如果 windowDrawsSystemBarBackgrounds 为 false，状态栏和导航栏背景都是黑色的-->
    <item name="android:windowDrawsSystemBarBackgrounds">true</item>

    <item name="android:windowTranslucentStatus">false</item>
    <item name="android:statusBarColor">@android:color/transparent</item>

    <item name="android:windowTranslucentNavigation">false</item>
    <item name="android:navigationBarColor">@android:color/transparent</item>

    <!--或者使用系统半透明效果-->
    <!--<item name="android:windowTranslucentStatus">true</item>-->
    <!--<item name="android:windowTranslucentNavigation">true</item>-->

</style>
```

在 5.0 模拟器上自定义颜色的效果，全透明：

<img src="./images/5_0-2.png" width="30%" height="30%">

使用系统的半透明的效果：

<img src="./images/5_0-1.png" width="30%" height="30%">

在 6.0 及以上的版本可以使用亮色主题的状态栏，这时状态栏文本颜色为灰色。新建文件夹 `res/values-v23`，添加 style:

``` xml
<style name="AppTheme.TransStats">

    <item name="android:windowFullscreen">false</item>

    <!--如果 windowDrawsSystemBarBackgrounds 为 false，状态栏和导航栏背景都是黑色的-->
    <item name="android:windowDrawsSystemBarBackgrounds">true</item>

    <item name="android:windowTranslucentStatus">false</item>
    <item name="android:statusBarColor">@android:color/transparent</item>

    <item name="android:windowTranslucentNavigation">false</item>
    <item name="android:navigationBarColor">@android:color/transparent</item>

    <!--或者使用系统半透明效果-->
    <!--<item name="android:windowTranslucentStatus">true</item>-->
    <!--<item name="android:windowTranslucentNavigation">true</item>-->

    <item name="android:windowLightStatusBar">true</item>

</style>
```

<img src="./images/6_0.png" width="30%" height="30%">

