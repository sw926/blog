<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="ivDuGQEgzzbV4a2s8kvcIqdCBx1EEZ7lMG2qq9mry24">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sw926.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="不忘初心，方得始终">
<meta property="og:type" content="website">
<meta property="og:title" content="小宇宙">
<meta property="og:url" content="http://sw926.com/page/3/index.html">
<meta property="og:site_name" content="小宇宙">
<meta property="og:description" content="不忘初心，方得始终">
<meta property="og:locale">
<meta property="article:author" content="sunwei">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://sw926.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>小宇宙</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小宇宙</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">燃烧吧</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2019/01/09/Karabiner-Elements/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/09/Karabiner-Elements/" class="post-title-link" itemprop="url">神器 Karabiner Elements 配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-09 14:54:55" itemprop="dateCreated datePublished" datetime="2019-01-09T14:54:55+08:00">2019-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:49:26" itemprop="dateModified" datetime="2020-04-06T18:49:26+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Other/" itemprop="url" rel="index"><span itemprop="name">Other</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Karabiner Elements，应该是 Mac 上必备的神器了，特别是使用 HHKB 的话。</p>
<h2 id="简单配置-Simple-Modifications"><a href="#简单配置-Simple-Modifications" class="headerlink" title="简单配置 Simple Modifications"></a>简单配置 <code>Simple Modifications</code></h2><p>HHKB 的键位不用改，但是 Mac 原生的键盘需要改键位，打开 <code>Karabiner-Elements Preferences</code>，切换到 <code>Simple Modifications</code>，<code>Target Device</code> 选择 <code>Apple Internal Keybord / Trackpad(No manufacturer name)</code>。</p>
<p>键盘名字可能不一样，只要确定是要修改的 Mac 键盘就行，修改方式很简单，点击左下角 <code>Add item</code>，选择 <code>From key</code> 和 <code>To key</code>，<code>From key</code> 为要修改的键，<code>To key</code> 为要修改成什么键。</p>
<p>Mac 原生键盘和 HHKB 统一的话使用以下配置，也就是左边 <code>control</code> 和 <code>caps lock</code> 交换位置，<code>delete</code> 和 <code>\</code> 交换位置。</p>
<p>![image](/images/屏幕快照 2019-01-09 15.02.22.png)</p>
<h2 id="使用现成的规则"><a href="#使用现成的规则" class="headerlink" title="使用现成的规则"></a>使用现成的规则</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Complex Modifications -&gt; Add rule -&gt; Import more rules from the Internet(open a web browser)</span><br></pre></td></tr></table></figure>
<p>搜索 Emac，添加 Emacs key bindings，添加完之后对应的规则为：</p>
<ul>
<li>Key Bindings (C-x key strokes) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C-x C-c Quit application (post command-q)</span><br><span class="line">C-x C-f Open file (post command-o)</span><br><span class="line">C-x C-s Save file (post command-s)</span><br></pre></td></tr></table></figure></li>
<li>Key Bindings (control+keys) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">control+d   forward delete</span><br><span class="line">control+h   delete</span><br><span class="line">control+i   tab</span><br><span class="line">control+[   escape</span><br><span class="line">control+m   return</span><br><span class="line">control+bfnp    arrow keys</span><br><span class="line">control+v   page down</span><br><span class="line">control+a (Microsoft Office)    home</span><br><span class="line">control+e (Microsoft Office)    end</span><br></pre></td></tr></table></figure></li>
<li>Key Bindings (option+keys) <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">option+v    page up</span><br><span class="line">option+bf   option+arrow keys</span><br><span class="line">option+d    option+forward delete</span><br></pre></td></tr></table></figure></li>
<li>Bash Style Key Bindings <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">control+w   Delete the word behind point (option+delete)</span><br><span class="line">control+u   Delete backward from point to the beginning of the line.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h2><p>添加完规则后有一些不完善的地方，例如，我喜欢用 <code>Control + j/l</code> 作为跳单词的快捷键，也就是代替 <code>opt</code> 加左右方向键，另外，设置完快捷键后 hhkb 在 vim 上方向组合键部分无效。</p>
<p>修改规则的时候只看比较重要的地方，我们要修改地方都是在 <code>rules</code> 下，<code>rules</code> 是一个数组，每条规则是一个 <code>manipulators</code>，<code>manipulators</code> 主要结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;pqrs.org&#x2F;osx&#x2F;karabiner&#x2F;json.html#complex_modifications-manipulator-definition</span><br></pre></td></tr></table></figure>
<p><code>Move Caret to Previous Word</code><br><code>Move Caret to Next Word</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2019/01/07/virtualenv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/07/virtualenv/" class="post-title-link" itemprop="url">Python 环境管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-01-07 17:54:05 / Modified: 19:57:41" itemprop="dateCreated datePublished" datetime="2019-01-07T17:54:05+08:00">2019-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="virtualenv"><a href="#virtualenv" class="headerlink" title="virtualenv"></a>virtualenv</h2><p>安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenv</span><br></pre></td></tr></table></figure>
<p>Mac 上要添加 <code>sudo</code></p>
<p>每个 <code>virtualenv</code> 使用文件夹进行区分，新建一个 <code>evn</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv my_project</span><br></pre></td></tr></table></figure>
<p>进入 <code>my_project</code> 文件夹，这时 <code>env</code> 还没有激活，激活 <code>evn</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> bin/activate</span><br></pre></td></tr></table></figure>
<p>这时命令会变成：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(my_project) ➜  my_project</span><br></pre></td></tr></table></figure>
<p><code>my_project</code> 使用的是默认的 <code>python</code> 版本，如果要指定 <code>env</code> 的版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv -p /usr/<span class="built_in">local</span>/bin/python3 my_project2</span><br></pre></td></tr></table></figure>
<p>激活后 <code>python</code> 的版本就会改变：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(my_project2) ➜  my_project2 python --version</span><br><span class="line">Python 3.7.1</span><br></pre></td></tr></table></figure>
<p>创建 <code>env</code> 是需要注意的一个命令是 <code>–system-site-packages</code>，加上这个命令会使用系统已经按照的第三方包，不加就算一个纯净的 <code>env</code> 版本。如果要关闭 <code>env</code>，输入 <code>deactivate</code> 就可以了。</p>
<p>如果要删除 <code>env</code>，直接删除对应的文件夹就行。</p>
<h2 id="virtualenvwrapper"><a href="#virtualenvwrapper" class="headerlink" title="virtualenvwrapper"></a>virtualenvwrapper</h2><p>一个文件夹一个 <code>env</code>，看上去非常方便，但是时间一长，谁知道自己创建了几个 <code>env</code> 的文件夹，管理起来不方便，所有我们需要有一个工具帮助我们使用 <code>virtualenv</code>。<code>virtualenvwrapper</code> 是 <code>virtualenv</code>，可以帮助我们管理 <code>env</code> 环境。</p>
<p>安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install virtualenvwrapper</span><br></pre></td></tr></table></figure>
<p>添加环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if [ -f &#x2F;usr&#x2F;local&#x2F;bin&#x2F;virtualenvwrapper.sh ]; then</span><br><span class="line">   export WORKON_HOME&#x3D;$HOME&#x2F;.virtualenvs </span><br><span class="line">   source &#x2F;usr&#x2F;local&#x2F;bin&#x2F;virtualenvwrapper.sh</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>以后我们所有的 <code>env</code> 都会安装到 <code>~/.virtualenvs</code> 文件夹下。如果打开名命令行的时候显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;python: No module named virtualenvwrapper</span><br><span class="line">virtualenvwrapper.sh: There was a problem running the initialization hooks.</span><br><span class="line"></span><br><span class="line">If Python could not import the module virtualenvwrapper.hook_loader,</span><br><span class="line">check that virtualenvwrapper has been installed for</span><br><span class="line">VIRTUALENVWRAPPER_PYTHON&#x3D;&#x2F;usr&#x2F;bin&#x2F;python and that PATH is</span><br><span class="line">set properly.</span><br></pre></td></tr></table></figure>
<p>那么把 <code>VIRTUALENVWRAPPER_PYTHON</code> 设置为 <code>Python3</code>。</p>
<p>创建一个 <code>virtualenv</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv venv</span><br></pre></td></tr></table></figure>
<p>创建的时候 <code>virtualenv</code> 参数同样适用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv -p /usr/<span class="built_in">local</span>/bin/python3 py3</span><br></pre></td></tr></table></figure>
<p>其他命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">lsvirtualenv -b <span class="comment"># 列出虚拟环境</span></span><br><span class="line"></span><br><span class="line">workon [虚拟环境名称] <span class="comment"># 切换虚拟环境</span></span><br><span class="line"></span><br><span class="line">lssitepackages <span class="comment"># 查看环境里安装了哪些包</span></span><br><span class="line"></span><br><span class="line">cdvirtualenv [子目录名] <span class="comment"># 进入当前环境的目录</span></span><br><span class="line"></span><br><span class="line">cpvirtualenv [<span class="built_in">source</span>] [dest] <span class="comment"># 复制虚拟环境</span></span><br><span class="line"></span><br><span class="line">deactivate <span class="comment"># 退出虚拟环境</span></span><br><span class="line"></span><br><span class="line">rmvirtualenv [虚拟环境名称] <span class="comment"># 删除虚拟环境</span></span><br></pre></td></tr></table></figure>
<h2 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h2><p>使用 <code>virtualenv</code> 和 <code>virtualenvwrapper</code> 可以方便的管理 <code>python</code> 环境，但是现在我们系统中只有两个版本 <code>python2</code> 和 <code>python3</code>，如果一个项目要求我们的 <code>python</code> 版本是 <code>3.6</code>，但是系统的 <code>python</code> 版本是 <code>3.7</code>，我们该怎么做呢？我们可以下载 <code>python3.6</code>，安装到一个文件夹，然后使用 <code>-p</code> 新建一个 <code>virtualenv</code> 环境。但是这样的话首先下载安装就很麻烦，需要打开浏览器，下载，解压，安装，其次鬼知道我们安装了多少个 <code>python</code> 版本，时间一长，很难管理，所以我们需要一个工具 <code>pyenv</code>。</p>
<p>安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pyenv</span><br></pre></td></tr></table></figure>
<p>添加环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval &quot;$(pyenv init -)&quot;</span><br></pre></td></tr></table></figure>
<p>查看 <code>python</code> 版本列表：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv install --list</span><br></pre></td></tr></table></figure>
<p>安装对应的版本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv install 3.6.7</span><br></pre></td></tr></table></figure>
<p>结果出错了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">BUILD FAILED (OS X 10.14.2 using python-build 20180424)</span><br><span class="line"></span><br><span class="line">Inspect or clean up the working tree at /var/folders/1d/_h3bhfsd33z3yf4x566ncqkw0000gn/T/python-build.20190107184844.88127</span><br><span class="line">Results logged to /var/folders/1d/_h3bhfsd33z3yf4x566ncqkw0000gn/T/python-build.20190107184844.88127.log</span><br><span class="line"></span><br><span class="line">Last 10 <span class="built_in">log</span> lines:</span><br><span class="line">  File <span class="string">&quot;/private/var/folders/1d/_h3bhfsd33z3yf4x566ncqkw0000gn/T/python-build.20190107184844.88127/Python-3.6.7/Lib/ensurepip/__main__.py&quot;</span>, line 5, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    sys.exit(ensurepip._main())</span><br><span class="line">  File <span class="string">&quot;/private/var/folders/1d/_h3bhfsd33z3yf4x566ncqkw0000gn/T/python-build.20190107184844.88127/Python-3.6.7/Lib/ensurepip/__init__.py&quot;</span>, line 204, <span class="keyword">in</span> _main</span><br><span class="line">    default_pip=args.default_pip,</span><br><span class="line">  File <span class="string">&quot;/private/var/folders/1d/_h3bhfsd33z3yf4x566ncqkw0000gn/T/python-build.20190107184844.88127/Python-3.6.7/Lib/ensurepip/__init__.py&quot;</span>, line 117, <span class="keyword">in</span> _bootstrap</span><br><span class="line">    <span class="built_in">return</span> _run_pip(args + [p[0] <span class="keyword">for</span> p <span class="keyword">in</span> _PROJECTS], additional_paths)</span><br><span class="line">  File <span class="string">&quot;/private/var/folders/1d/_h3bhfsd33z3yf4x566ncqkw0000gn/T/python-build.20190107184844.88127/Python-3.6.7/Lib/ensurepip/__init__.py&quot;</span>, line 27, <span class="keyword">in</span> _run_pip</span><br><span class="line">    import pip._internal</span><br><span class="line">zipimport.ZipImportError: can<span class="string">&#x27;t decompress data; zlib not available</span></span><br><span class="line"><span class="string">make: *** [install] Error 1</span></span><br></pre></td></tr></table></figure>
<p>Google 的解决方法，首先：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure>
<p>如果不行的话：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CFLAGS=<span class="string">&quot;-I<span class="subst">$(brew --prefix openssl)</span>/include -I<span class="subst">$(xcrun --show-sdk-path)</span>/usr/include&quot;</span> \</span><br><span class="line">LDFLAGS=<span class="string">&quot;-L<span class="subst">$(brew --prefix openssl)</span>/lib&quot;</span></span><br></pre></td></tr></table></figure>
<p>最终还是不行，尝试用 <code>brew</code> 安装 <code>zlib</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install zlib</span><br></pre></td></tr></table></figure>
<p>然后添加环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDFLAGS&#x3D;&quot;-L&#x2F;usr&#x2F;local&#x2F;opt&#x2F;zlib&#x2F;lib&quot;</span><br><span class="line">CPPFLAGS&#x3D;&quot;-I&#x2F;usr&#x2F;local&#x2F;opt&#x2F;zlib&#x2F;include&quot;</span><br></pre></td></tr></table></figure>
<p>但是仍然没有用，最后：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo installer -pkg /Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg -target /</span><br></pre></td></tr></table></figure>
<p>成功！</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ pyenv install 3.6.7</span><br><span class="line">python-build: use openssl from homebrew</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Downloading Python-3.6.7.tar.xz...</span><br><span class="line">-&gt; https://www.python.org/ftp/python/3.6.7/Python-3.6.7.tar.xz</span><br><span class="line">Installing Python-3.6.7...</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Installed Python-3.6.7 to /Users/sunwei/.pyenv/versions/3.6.7</span><br></pre></td></tr></table></figure>
<p>然后查看 <code>python</code> 版本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ pyenv versions</span><br><span class="line">* system (<span class="built_in">set</span> by /Users/sunwei/.pyenv/version)</span><br><span class="line">  3.6.7</span><br></pre></td></tr></table></figure>
<p>当前使用的是系统中的 <code>python</code>，我们切换成刚才安装的 <code>3.6.7</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ pyenv global 3.6.7</span><br><span class="line">➜  ~ python --version</span><br><span class="line">Python 3.6.7</span><br></pre></td></tr></table></figure>
<p>设置全局版本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv global 3.6.7</span><br></pre></td></tr></table></figure>
<p>只对当前目录有效：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv <span class="built_in">local</span> 3.6.7</span><br></pre></td></tr></table></figure>
<p>对当前 <code>shell</code> 有效：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv shell 3.6.7</span><br></pre></td></tr></table></figure>
<p>和 <code>virtualenv</code> 结合使用，需要安装插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pyenv-virtualenv</span><br></pre></td></tr></table></figure>
<p>新建一个指定 <code>python</code> 版本的 <code>virtualenv</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pyenv virtualenv &lt;版本号&gt; &lt;文件夹&gt;</span></span><br><span class="line">pyenv virtualenv 3.6.7 my_env</span><br></pre></td></tr></table></figure>
<p>新建的 <code>virtualenv</code> 需要指定目录，还是不好管理，那么终极解决方案，使用 <code>pyenv-virtualenvwrapper</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pyenv-virtualenvwrapper</span><br></pre></td></tr></table></figure>
<p>安装完后需要激活一下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyenv virtualenvwrapper </span><br></pre></td></tr></table></figure>
<p>然后是使用，我们想新建一个 <code>python3.6.7</code> 版本的 <code>virtualenvwrapper</code>，</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyenv shell 3.6.7</span><br><span class="line">pip install virtualenvwrapper  <span class="comment"># 第一次使用新的 Python 环境需要安装此包，否则创建的虚拟环境 Python 版本仍为系统默认</span></span><br><span class="line">mkvirtualenv python3</span><br></pre></td></tr></table></figure>
<p>检查一下结果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ workon py3.6.7</span><br><span class="line">(py3.6.7) ➜  ~ python --version</span><br><span class="line">Python 3.6.7</span><br></pre></td></tr></table></figure>
<p>大公告成！</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://codingpy.com/article/virtualenv-must-have-tool-for-python-development/">http://codingpy.com/article/virtualenv-must-have-tool-for-python-development/</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/jeikerxiao/article/details/53635267">https://blog.csdn.net/jeikerxiao/article/details/53635267</a><br><a target="_blank" rel="noopener" href="https://lisupy.github.io/2018/10/01/2018-10-01-Mojave%E4%BD%BF%E7%94%A8pyenv%E5%AE%89%E8%A3%85python/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">https://lisupy.github.io/2018/10/01/2018-10-01-Mojave%E4%BD%BF%E7%94%A8pyenv%E5%AE%89%E8%A3%85python/#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95</a><br><a target="_blank" rel="noopener" href="https://my.oschina.net/OHC1U9jZt/blog/2243919">https://my.oschina.net/OHC1U9jZt/blog/2243919</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30859003">https://zhuanlan.zhihu.com/p/30859003</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2019/01/07/Android%E5%85%A8%E5%B1%8F%E5%88%87%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/07/Android%E5%85%A8%E5%B1%8F%E5%88%87%E6%8D%A2/" class="post-title-link" itemprop="url">Android全屏切换</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-07 14:14:33" itemprop="dateCreated datePublished" datetime="2019-01-07T14:14:33+08:00">2019-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:48:32" itemprop="dateModified" datetime="2020-04-06T18:48:32+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Android Framework 中很多地方使用了标志位，<code>View</code> 的 <code>SystemUiVisibility</code> 就是一种，虽然只是一个 <code>Int</code> 类型，但是转换成二进制，每一位都可以做一个开关。</p>
<p>添加一个标志：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uiOptions = uiOptions or View.SYSTEM_UI_FLAG_LOW_PROFILE</span><br></pre></td></tr></table></figure>
<p>移除一个标志：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uiOptions = uiOptions and View.SYSTEM_UI_FLAG_LOW_PROFILE.inv()</span><br></pre></td></tr></table></figure>
<p>视频播放进入全屏，要隐藏状态栏，Actionbar，导航栏。需要注意的是全屏和横竖屏切换是两个独立的东西。</p>
<p>其实在 Android 上没有一个全屏的 Api，做全屏的功能需要一列的操作进行组合，而且要考虑版本的兼容。</p>
<p>首先，有 Actionbar 的话要隐藏：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (activity <span class="keyword">is</span> AppCompatActivity) &#123;</span><br><span class="line">    activity.supportActionBar?.hide()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    activity.actionBar?.hide()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们开始设置 <code>systemUiVisibility</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> uiOptions = activity.window.decorView.systemUiVisibility</span><br><span class="line"></span><br><span class="line">uiOptions = uiOptions or View.SYSTEM_UI_FLAG_LOW_PROFILE</span><br><span class="line">uiOptions = uiOptions or View.SYSTEM_UI_FLAG_FULLSCREEN</span><br><span class="line">uiOptions = uiOptions or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE</span><br><span class="line">    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">activity.window.decorView.systemUiVisibility = uiOptions</span><br></pre></td></tr></table></figure>
<p>为了兼容低版本，还要设置 window 的 flag</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> attrs = activity.window.attributes</span><br><span class="line">attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_FULLSCREEN</span><br><span class="line">attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON</span><br><span class="line">activity.window.attributes = attrs</span><br></pre></td></tr></table></figure>
<p>要退出全屏，把进入全屏时的设置全部清除就可以了，最终的代码为：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">enterFullScreen</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">is</span> AppCompatActivity) &#123;</span><br><span class="line">        activity.supportActionBar?.hide()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        activity.actionBar?.hide()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> attrs = activity.window.attributes</span><br><span class="line">    attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_FULLSCREEN</span><br><span class="line">    attrs.flags = attrs.flags or WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON</span><br><span class="line">    activity.window.attributes = attrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> uiOptions = activity.window.decorView.systemUiVisibility</span><br><span class="line"></span><br><span class="line">    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_LOW_PROFILE</span><br><span class="line">    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_FULLSCREEN</span><br><span class="line">    uiOptions = uiOptions or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE</span><br><span class="line">        uiOptions = uiOptions or View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    activity.window.decorView.systemUiVisibility = uiOptions</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">existFullScreen</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">is</span> AppCompatActivity) &#123;</span><br><span class="line">        activity.supportActionBar?.show()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        activity.actionBar?.show()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> attrs = activity.window.attributes</span><br><span class="line">    attrs.flags = attrs.flags and WindowManager.LayoutParams.FLAG_FULLSCREEN.inv()</span><br><span class="line">    attrs.flags = attrs.flags and WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON.inv()</span><br><span class="line">    activity.window.attributes = attrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> uiOptions = activity.window.decorView.systemUiVisibility</span><br><span class="line"></span><br><span class="line">    uiOptions = uiOptions and View.SYSTEM_UI_FLAG_LOW_PROFILE.inv()</span><br><span class="line">    uiOptions = uiOptions and View.SYSTEM_UI_FLAG_FULLSCREEN.inv()</span><br><span class="line">    uiOptions = uiOptions and View.SYSTEM_UI_FLAG_HIDE_NAVIGATION.inv()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        uiOptions = uiOptions and View.SYSTEM_UI_FLAG_IMMERSIVE.inv()</span><br><span class="line">        uiOptions = uiOptions and View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY.inv()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    activity.window.decorView.systemUiVisibility = uiOptions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2019/01/04/%E5%B8%B8%E7%94%A8%E7%9A%84Android-Dependencies/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/04/%E5%B8%B8%E7%94%A8%E7%9A%84Android-Dependencies/" class="post-title-link" itemprop="url">常用的Android Dependencies</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-01-04 11:16:00" itemprop="dateCreated datePublished" datetime="2019-01-04T11:16:00+08:00">2019-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-01-07 14:22:14" itemprop="dateModified" datetime="2019-01-07T14:22:14+08:00">2019-01-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>2019.01.04</p>
<h2 id="启用-DataBinding："><a href="#启用-DataBinding：" class="headerlink" title="启用 DataBinding："></a>启用 DataBinding：</h2><p>在项目根目录下的 <code>gradle.properties</code> 下添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.databinding.enableV2&#x3D;true</span><br></pre></td></tr></table></figure>
<p>在 <code>app</code> 目录下的 <code>build.gradle</code> 下添加：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    dataBinding &#123;</span><br><span class="line">        enabled = <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="lifecycle"><a href="#lifecycle" class="headerlink" title="lifecycle"></a>lifecycle</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&#x27;android.arch.lifecycle:common-java8:1.1.1&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;android.arch.lifecycle:extensions:1.1.1&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;android.arch.lifecycle:runtime:1.1.1&#x27;</span></span><br></pre></td></tr></table></figure>
<p>上面的依赖使用的是 Java8，不用添加 <code>apt</code> 或者 <code>kapt</code> 或者 <code>annotationProcessor</code>，但是需要设置 <code>compileOptions</code>：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        <span class="keyword">sourceCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line">        <span class="keyword">targetCompatibility</span> JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Navigation"><a href="#Navigation" class="headerlink" title="Navigation"></a>Navigation</h2><p>根目录下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">&quot;android.arch.navigation:navigation-safe-args-gradle-plugin:1.0.0-alpha09&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>app</code> 目录下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&quot;androidx.navigation.safeargs&quot;</span></span><br></pre></td></tr></table></figure>
<p>添加依赖：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&quot;android.arch.navigation:navigation-fragment-ktx:1.0.0-alpha09&quot;</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line">implementation <span class="string">&quot;android.arch.navigation:navigation-ui-ktx:1.0.0-alpha09&quot;</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// optional - Test helpers</span></span><br><span class="line">androidTestImplementation <span class="string">&quot;android.arch.navigation:navigation-testing-ktx:1.0.0-alpha06&quot;</span> <span class="comment">// use -ktx for Kotlin</span></span><br></pre></td></tr></table></figure>
<p>在 <code>Android Studio 3.2</code> 中，还要开启 <code>Experimental</code> 设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Preferences -&gt; Experimental</span><br></pre></td></tr></table></figure>
<p>剩下的就是在 <code>res</code> 目录下新建 <code>navigation</code> 文件夹，添加一个 <code>navigation.xml</code> 文件</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2018/12/27/Flutter%E7%AC%94%E8%AE%B020181227/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/27/Flutter%E7%AC%94%E8%AE%B020181227/" class="post-title-link" itemprop="url">Flutter笔记20181227</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-27 18:01:56" itemprop="dateCreated datePublished" datetime="2018-12-27T18:01:56+08:00">2018-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:48:04" itemprop="dateModified" datetime="2020-04-06T18:48:04+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Flutter 的 Widget 有两种，<code>StatelessWidget</code> 和 <code>StatefulWidget</code>，前者是 immutable 的，一旦创建不能改变，后者是是可以改变的。Flutter 使用的是响应式布局，简单说就是 UI 随着 <code>state</code> 而改变，我们要做的只是修改 <code>state</code>，没有 <code>setText()</code>、<code>setColor()</code> 这些操作了。</p>
<h2 id="引入图资源"><a href="#引入图资源" class="headerlink" title="引入图资源"></a>引入图资源</h2><p>在 <code>pubspec.yaml</code> 中添加</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">flutter:</span></span><br><span class="line">  <span class="attr">assets:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">images/entry_bg.png</span></span><br></pre></td></tr></table></figure>
<p>文件目录名字可以自定义，不同分辨率的区分使用 <code>1.0x</code>、<code>2.0x</code>这样，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">images\2.0x\entry_bg.png</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2018/12/27/Java-Time/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/27/Java-Time/" class="post-title-link" itemprop="url">Java Time</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-27 11:10:41" itemprop="dateCreated datePublished" datetime="2018-12-27T11:10:41+08:00">2018-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:48:15" itemprop="dateModified" datetime="2020-04-06T18:48:15+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>时间和日期的处理是一个非常复杂的事情，不仅仅有年月日，还有时区，星期，各种时间格式的转换，最复杂的，各种日历之间的转换。现在的公历，也叫格里高利历，其实算是最简单的日历了，因为基本上能通过数学计算来预测，至于伊斯兰历、中国农历，则要结合天文观测，要和公历相互转换是非常复杂的。</p>
<p>Java 处理时间和日期一般是通过 <code>Date</code> 和 <code>Calendar</code>，这两个 Api 也是非常难用的 Api，相信用过的人都有体会。Java 上当然不可能有没有一个好用的 Time Api，所以有了 JSR310。在 Java8 中可以使用 <code>java.time</code>，如果项目不允许使用 Java8 及以上的版本，那么还有替代方案，Joda-Time 和 Threetenabp，Threetenabp 和 <code>java.time</code> 的 Api 兼容，Joda-Time 和 <code>java.time</code> 的 Api 不同，但是很相似。</p>
<p>使用 <code>java.time</code>，主要会用到下面的类：</p>
<ul>
<li>LocalTime 时间</li>
<li>LocalDate 日期</li>
<li>LocalDateTime 时间和日期</li>
<li>ZonedDateTime 时间日期加时区</li>
<li>Year 年</li>
<li>YearMonth 年月</li>
<li>MonthDay 一月的一天</li>
<li>Instant 距离 1970-01-01 的时间</li>
</ul>
<p>另外还有时区 Zone，和偏移 Offset</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> nowTime = LocalTime.now()</span><br><span class="line">    <span class="keyword">val</span> nowDate = LocalDate.now()</span><br><span class="line">    <span class="keyword">val</span> nowDateTime = LocalDateTime.now()</span><br><span class="line">    <span class="keyword">val</span> nowZonedDateTime = ZonedDateTime.now()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> year = Year.now()</span><br><span class="line">    <span class="keyword">val</span> yearMonth = YearMonth.now()</span><br><span class="line">    <span class="keyword">val</span> monthDay = MonthDay.now()</span><br><span class="line">    <span class="keyword">val</span> instant = Instant.now()</span><br><span class="line"></span><br><span class="line">    println(nowTime)</span><br><span class="line">    println(nowDate)</span><br><span class="line">    println(nowDateTime)</span><br><span class="line">    println(nowZonedDateTime)</span><br><span class="line"></span><br><span class="line">    println(year)</span><br><span class="line">    println(yearMonth)</span><br><span class="line">    println(monthDay)</span><br><span class="line">    println(instant)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">11:29:18.220498</span><br><span class="line">2018-12-27</span><br><span class="line">2018-12-27T11:29:18.220886</span><br><span class="line">2018-12-27T11:29:18.223397+08:00[Asia&#x2F;Shanghai]</span><br><span class="line">2018</span><br><span class="line">2018-12</span><br><span class="line">--12-27</span><br><span class="line">2018-12-27T03:29:18.235191Z</span><br></pre></td></tr></table></figure>
<p>以上的类都有一个特点，就是 <code>immutable</code>，一旦创建就不可改变。<code>immutable</code> 有什么好处呢，那就是线程安全，如果持有上面的任何一个类的引用，在使用的使用不用担心这个引用的内容会被改变。<code>immutable</code> 是怎么实现的呢？上面的类的所有公开的方法都不能改变对象的内容。</p>
<p>如果我们想修改一个日期或月份怎么办呢？答案是无法修改，只能重新生成一个对象，例如：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> date1 = LocalDate.now()</span><br><span class="line"><span class="keyword">val</span> date2 = date1.withMonth(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><code>withMonth</code> 不会改变 <code>date1</code>，它会返回一个新的对象，所以 <code>java.time</code> 和时间相关的对象是没有 <code>setter</code> 方法的。</p>
<p>对于程序员来说，时间最简单的表述方式就是一个 <code>Long</code> 类型的变量，值是距离零时区 1970-01-01 零点的时间，但是这个时间不是人类可读的，使用 <code>Calendar</code> 的时候，一个 <code>Calendar</code> 对象包含的所有日期的信息，年月日时区都有，而且有 <code>setter</code> 方法，但是 <code>java.time</code> 不是这样的，</p>
<ul>
<li><code>LocalDate</code> 只有日期的信息</li>
<li><code>LocalTime</code> 只有时间的信息</li>
<li><code>LocalDateTime</code> 虽然有日期和时间，但是没有时区</li>
</ul>
<p>我们平常使用的比较多的是将一个 Long 类型的时间戳，或者一个时间字符串转换为时间对象，时间戳和字符串都是包含完整时间信息的，我们需要注意的就是不要在转换的过程中丢失时区，</p>
<p>例如时间时间戳：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1545888556889</span><br></pre></td></tr></table></figure>
<p>转换为 <code>Instant</code> 为：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> instant = Instant.ofEpochMilli(<span class="number">1545888556889</span>)</span><br><span class="line">print(instant)</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-12-27T05:29:16.889Z </span><br></pre></td></tr></table></figure>
<p>是零时区的，这是我们将这个 <code>Instant</code> 转换为 <code>Local</code> 开头的时间：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> <span class="keyword">data</span> = LocalDate.ofInstant(instant, ZoneId.systemDefault())</span><br><span class="line"><span class="keyword">val</span> time = LocalTime.ofInstant(instant, ZoneId.systemDefault())</span><br><span class="line"><span class="keyword">val</span> dataTime = LocalDateTime.ofInstant(instant, ZoneId.systemDefault())</span><br></pre></td></tr></table></figure>
<p>可以看到必须要加上时区，这时候还是很安全的，但是从字符串转换的话就很容易出错了，例如字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-12-27T05:29:16.889Z</span><br></pre></td></tr></table></figure>
<p>我们使用 <code>parse</code> 方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> str = <span class="string">&quot;2018-12-27T05:29:16.889Z&quot;</span></span><br><span class="line"><span class="keyword">val</span> dateTime = ZonedDateTime.parse(str)</span><br><span class="line">println(dateTime)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> localDate = dateTime.toLocalDate()</span><br><span class="line"><span class="keyword">val</span> localTime = dateTime.toLocalTime()</span><br><span class="line"><span class="keyword">val</span> localDateTime = dateTime.toLocalDateTime()</span><br><span class="line"></span><br><span class="line">println(ZoneId.systemDefault())</span><br><span class="line">println(localDate)</span><br><span class="line">println(localTime)</span><br><span class="line">println(localDateTime)</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-12-27T05:29:16.889Z</span><br><span class="line">Asia&#x2F;Shanghai</span><br><span class="line">2018-12-27</span><br><span class="line">05:29:16.889</span><br><span class="line">2018-12-27T05:29:16.889</span><br></pre></td></tr></table></figure>
<p><code>2018-12-27T05:29:16.889Z</code> 是零时区的时间，当前我们的时区是东八区，但是 <code>LocalTime</code>、<code>LocalDate</code> 和 <code>LocalDateTime</code> 都是按零时区显示的，用户在使用的时候，看到的就是错误的时间。</p>
<p>要解决这个问题，需要首先将 <code>ZonedDateTime</code> 的时区转换为东八区，方法为</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> str = <span class="string">&quot;2018-12-27T05:29:16.889Z&quot;</span></span><br><span class="line"><span class="keyword">val</span> dateTime = ZonedDateTime.parse(str).withZoneSameInstant(ZoneId.systemDefault())</span><br><span class="line">println(dateTime)</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-12-27T13:29:16.889+08:00[Asia&#x2F;Shanghai]</span><br></pre></td></tr></table></figure>







      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2018/06/13/Android-room/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/13/Android-room/" class="post-title-link" itemprop="url">Android Room</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-13 17:16:23" itemprop="dateCreated datePublished" datetime="2018-06-13T17:16:23+08:00">2018-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:47:55" itemprop="dateModified" datetime="2020-04-06T18:47:55+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>Android Room 作为 Android Architecture 的 orm 部分，接入是非常简单的。</p>
<p>首先明确 Room 能做什么，简单概括，能让你把一行 SQL 语句变成对象，是现在最好用的 ORM 框架，当然这是废话，官方能拿的出来，肯定要比第三方的要好。首先体验一下：</p>
<p>简单的插入数据，不用写 SQL:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">insertAll</span><span class="params">(<span class="keyword">vararg</span> record: <span class="type">Record</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(record: <span class="type">Record</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>查询数据，一行 SQL，一个函数声明搞定</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(<span class="meta-string">&quot;SELECT * FROM Record&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getAll</span><span class="params">()</span></span>: List&lt;Record&gt;</span><br></pre></td></tr></table></figure>
<p>而且 SQL 是有<strong>代码提示</strong>和<strong>语法检查</strong>的。</p>
<p>下面，我们在现有项目上使用 Room，使用新的orm框架，而不用对数据库结构做任何修改。</p>
<h2 id="添加-Room"><a href="#添加-Room" class="headerlink" title="添加 Room"></a>添加 Room</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> room_version = <span class="string">&quot;1.1.0&quot;</span> <span class="comment">// or, for latest rc, use &quot;1.1.1-rc1&quot;</span></span><br><span class="line"></span><br><span class="line">implementation <span class="string">&quot;android.arch.persistence.room:runtime:$room_version&quot;</span></span><br><span class="line">kapt <span class="string">&quot;android.arch.persistence.room:compiler:$room_version&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h2><p>现在的项目数据量有个 Record table，创建的 SQL 语句为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Record (</span><br><span class="line">    _id <span class="type">INTEGER</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY AUTOINCREMENT,</span><br><span class="line">    <span class="type">date</span> <span class="type">INTEGER</span> <span class="keyword">UNIQUE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    records TEXT,</span><br><span class="line">    need_sync <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">0</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>主键为 <code>_id</code>，<code>data</code> 为整型，存储的是时间，<code>records</code> 为字符串，是一个 json 对象，<code>need_sync</code> 是一个 Boolean，以整型存储在数据库中。</p>
<p>我想做的：</p>
<ul>
<li><code>_id</code> 在数据类中要名字是 <code>id</code></li>
<li><code>date</code> 为 UNIQUE</li>
<li><code>date</code> 直接读取为 LocalDate 对象</li>
<li><code>records</code> 直接读取为 Bean 对象</li>
<li><code>need_sync</code> 直接读取为 Boolean，数据类中的名字当然也要改</li>
</ul>
<p>最终的 Entity 类声明为：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity(tableName = <span class="meta-string">&quot;Record&quot;</span>, indices = [(Index(value = arrayOf(<span class="meta-string">&quot;date&quot;</span>)</span>, unique = <span class="literal">true</span>))])</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Record</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PrimaryKey(autoGenerate = true)</span></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;_id&quot;</span>)</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Long</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> date: LocalDate? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> records: Bean? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ColumnInfo(name = <span class="meta-string">&quot;need_sync&quot;</span>)</span></span><br><span class="line">    <span class="keyword">var</span> needSync = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了类声明，我们不需要 SQL 语句去创建 Table</p>
<h2 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h2><p>RecordDao，用来访问数据对象：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RecordDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insertAll</span><span class="params">(<span class="keyword">vararg</span> record: <span class="type">Record</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(record: <span class="type">Record</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">delete</span><span class="params">(record: <span class="type">Record</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteAll</span><span class="params">(<span class="keyword">vararg</span> record: <span class="type">Record</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(record: <span class="type">Record</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="meta-string">&quot;SELECT * FROM Record&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getAll</span><span class="params">()</span></span>: List&lt;Record&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Query(<span class="meta-string">&quot;SELECT * FROM Record WHERE date = :date&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getByDate</span><span class="params">(date: <span class="type">LocalDate</span>)</span></span>: List&lt;Record&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接的插入、删除、更新是不用写 SQL，自定义的查询还是需要写 SQL，可以直接在 SQL 语句中绑定函数参数，只要在参数名字前加 “:” 就可以了，像 <code>getByDate</code>，<code>:date</code> 就是标识函数的 date 参数就是 SQL 中的参数：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query(<span class="meta-string">&quot;SELECT * FROM Record WHERE date = :date&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getByDate</span><span class="params">(date: <span class="type">LocalDate</span>)</span></span>: List&lt;Record&gt;</span><br></pre></td></tr></table></figure>
<p><code>@Query</code> 里面的 SQL 语句不仅有代码提示，而且有语法检查，写错 table name 和 函数参数名都会报错的，手残党的福音啊。</p>
<h2 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h2><p>Entity 和 Dao 都声明好了，现在要创建数据库了，还记得之前怎么做的吗：</p>
<ul>
<li>继承 SQLiteOpenHelper</li>
<li><code>onCreate</code> 执行 SQL 语句创建数据库</li>
<li><code>onUpgrade</code> 进行 Migration</li>
<li><code>execSQL</code> 获取 <code>Cursor</code></li>
<li>把 <code>Cursor</code> 转换为对象</li>
</ul>
<p>如果使用 Room 呢？</p>
<p>没有 SQLiteOpenHelper 了，也没有 <code>onCreate</code> 了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = [(Record::class)</span>], version = <span class="number">10</span>)</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDataBase</span> : <span class="type">RoomDatabase</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">recordDao</span><span class="params">()</span></span>: RecordDao</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库创建的声明完成了，使用了 Room，要接受这几点：</p>
<ul>
<li>不需要 <code>SQLiteOpenHelper</code></li>
<li>不需要 <code>Cursor</code></li>
<li>可能连 <code>SQLiteDatabase</code> 也不需要</li>
</ul>
<h2 id="TypeConverters"><a href="#TypeConverters" class="headerlink" title="TypeConverters"></a>TypeConverters</h2><p>上面是创建数据库的全部代码了吗？当然不是，我们还需要 TypeConverters 和 Migration，</p>
<p>date 在数据里面以 Long 的形式存储，读取的时候需要转换为 LocalDate 对象，存储的时候需要把 LocalDate 转换为 Long，对于一种转换关系，我们只需要声明一个静态函数就可以了，名字随意，参数和返回值的类型为对应的转换关系。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbTypeConverters</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@TypeConverter</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">toLocalDate</span><span class="params">(value: <span class="type">Long</span>)</span></span>: LocalDate =</span><br><span class="line">                LocalDateTime.ofInstant(Instant.ofEpochMilli(value), ZoneId.systemDefault()).toLocalDate()</span><br><span class="line"></span><br><span class="line">        <span class="meta">@TypeConverter</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">toLocalDate</span><span class="params">(value: <span class="type">LocalDate</span>)</span></span>: <span class="built_in">Long</span> =</span><br><span class="line">                value.atStartOfDay(ZoneId.of(<span class="string">&quot;UTC&quot;</span>)).toInstant().toEpochMilli()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后把 TypeConverters 添加到 Database</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = [(Record::class)</span>], version = <span class="number">10</span>)</span><br><span class="line"><span class="meta">@TypeConverters(DbTypeConverters::class)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDataBase</span> : <span class="type">RoomDatabase</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">recordDao</span><span class="params">()</span></span>: RecordDao</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Migrations"><a href="#Migrations" class="headerlink" title="Migrations"></a>Migrations</h2><p>数据库升级，我们需要声明的是一个 Migration，</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> PeriodDbMigration &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> MIGRATION_1_2 = <span class="keyword">object</span> : Migration(<span class="number">1</span>, <span class="number">2</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">migrate</span><span class="params">(database: <span class="type">SupportSQLiteDatabase</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// update</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> MIGRATION_3_4 = <span class="keyword">object</span> : Migration(<span class="number">3</span>, <span class="number">4</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">migrate</span><span class="params">(db: <span class="type">SupportSQLiteDatabase</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// update</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和 SQLiteOpenHelper 的 onUpgrade 一样，只不过每次升级拆分为一次 Migration 操作。</p>
<p>然后就是创建数据库：</p>
<p>通过 addMigrations 添加数据库升级的操作，</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> database = Room.databaseBuilder(application, PeriodDataBase.<span class="keyword">class</span>, <span class="string">&quot;database.db&quot;</span>)</span><br><span class="line">                .addMigrations(PeriodDbMigration.MIGRATION_1_2, PeriodDbMigration.MIGRATION_3_4)</span><br><span class="line">                .allowMainThreadQueries()</span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure>
<p><code>allowMainThreadQueries()</code> 是允许在主线程上进行操作，对于之前在主线程上读写数据的同学们，先加上 <code>allowMainThreadQueries()</code>，然后慢慢优化吧。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>一般会把数据作为单例使用，然后调用 Dao 中函数就可以了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> all = database.recordDao().getAll()</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2018/05/16/Android-Keyboard%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/16/Android-Keyboard%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">Android Keyboard开发</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-05-16 16:17:43" itemprop="dateCreated datePublished" datetime="2018-05-16T16:17:43+08:00">2018-05-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:47:39" itemprop="dateModified" datetime="2020-04-06T18:47:39+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>要开始做 Android 键盘的开发，最好首先参考一下 Api Demo 里面的 SoftKeyboard 例子。这个例子比较老了，导入到 Android Studio 之后会发现无法运行，这是因为没有 Launcher Activity，在 Run/Debug Configurations 里面把 Launch Options 设置为 Nothing 后就能运行了，当然运行后在桌面是看不懂图标的，需要在设置里面添加输入法，之后再输入文本的时候就能调出刚才安装的输入法了。<br>设置界面是在 AndroidManifest.xml 里面声明的：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    android:name=&quot;.ImePreferences&quot;</span><br><span class="line">    android:exported=&quot;false&quot;</span><br><span class="line">    android:label=&quot;@string/settings_name&quot;&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>跳转到 ImePreferences.java，发现它是一个 Activity，继承自 PreferenceActivity，不过有个一个警告，意思是 PreferenceActivity 的子类不能 export，那么修改一一下 AndroidManifest.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    android:name=&quot;.ImePreferences&quot;</span><br><span class="line">    android:exported=&quot;false&quot;</span><br><span class="line">    android:label=&quot;@string/settings_name&quot;&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>警告消失了，这是个输入法的设置界面，总是到系统设置里面找不太方便，我们效仿其他输入法，在程序列表里面添加一个主界面，既然 ImePreferences 是 Activity 那么我们之间 start 这个 Activity 就可以了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intent = Intent(<span class="keyword">this</span>, ImePreferences::<span class="keyword">class</span>.java)</span><br><span class="line">startActivity(intent)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2018/02/24/Dagger2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/02/24/Dagger2/" class="post-title-link" itemprop="url">Dagger2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-02-24 16:40:57" itemprop="dateCreated datePublished" datetime="2018-02-24T16:40:57+08:00">2018-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:47:27" itemprop="dateModified" datetime="2020-04-06T18:47:27+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Dagger是一个注入工具，何为注入，我们要生产一批机器人，每个机器人都有一个控制器，我们可以在机器人内部 new 出一个控制器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> controller = Controller()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码 Robot 和 Controller 耦合，修改一下上面的代码，从外部传入控制器，这就叫注入：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span></span>(<span class="keyword">val</span> controller: Controller)</span><br></pre></td></tr></table></figure>
<p>这样做的好处就是修改了控制器，但是不用修改机器人的代码，一般情况下，我们需要把控制器声明为接口，这样一个机器人就可以兼容不同的控制器</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">move</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicController</span> : <span class="type">Controller &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">move</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdvancedController</span> : <span class="type">Controller &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">move</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// ..</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span></span>(<span class="keyword">val</span> controller: Controller)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">createRobot</span><span class="params">(controller: <span class="type">Controller</span>)</span></span> = Robot(controller)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> basicRobot = createRobot(BasicController())</span><br><span class="line">    <span class="keyword">val</span> advancedRobot = createRobot(AdvancedController())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码就是精简版的Dagger，当然结构天差地别，但是思路差不多，下面开始讲Dagger。<br>Dagger是个注入框架，帮助我们来实现注入的功能，拿上面的例子来说，我们写好了 Robot 和 各种 Controller 的代码，Dagger 帮我们将他们联系起来，也就是实现函数 createRobot 的功能。<br>Dagger2 的功能是通过编译器生成中间代码来实现的，编译器可以为我们生成代码，但是要生成什么代码是需要我们指定的，拿上面的例子来说，我们需要为 Robot 注入一个 Controller，我们需要指定：</p>
<ul>
<li>Controller 的构造方法</li>
<li>需要注入的成员变量</li>
<li>在什么地方注入</li>
</ul>
<p>未使用 Dagger 之前，代码是这样的： </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span></span>(<span class="keyword">val</span> controller: Controller)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> controller = Controller()</span><br><span class="line"><span class="keyword">val</span> robot = Robot(controller)</span><br></pre></td></tr></table></figure>
<p>现在我们来改写代码，首先要指定 Controller 的构造方法，在 Controller 的构造函数添加 @Inject 注解：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()</span><br></pre></td></tr></table></figure>
<p>指定需要注入的变量</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>现在编译一下，等待 Dagger 生成中间代码，Dagger为我们生成以下的代码： </p>
<p>Controller_Factory.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller_Factory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">Controller</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Controller_Factory INSTANCE = <span class="keyword">new</span> Controller_Factory();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Controller <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Controller();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Factory&lt;Controller&gt; <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Robot_MembersInjector.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Robot_MembersInjector</span> <span class="keyword">implements</span> <span class="title">MembersInjector</span>&lt;<span class="title">Robot</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Provider&lt;Controller&gt; controllerProvider;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Robot_MembersInjector</span><span class="params">(Provider&lt;Controller&gt; controllerProvider)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> controllerProvider != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.controllerProvider = controllerProvider;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MembersInjector&lt;Robot&gt; <span class="title">create</span><span class="params">(Provider&lt;Controller&gt; controllerProvider)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Robot_MembersInjector(controllerProvider);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(Robot instance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Cannot inject members into a null reference&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    instance.controller = controllerProvider.get();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常好，Dagger 为我们生成了一个 Controller 的构造类 Controller_Factory，我们可以通过</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Controller_Factory.create()</span><br></pre></td></tr></table></figure>
<p>获取一个单例的 Controller 对象，或者通过：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Controller_Factory().<span class="keyword">get</span>()</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">Controller_Factory.create().<span class="keyword">get</span>()</span><br></pre></td></tr></table></figure>
<p>创建一个新的 Controller 对象，如果要注入到 Robot，需要使用 Robot_MembersInjector 的 injectMembers 的函数，改造后的最终代码是</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">val</span> factory = Controller_Factory.create()</span><br><span class="line">        <span class="keyword">val</span> injector = Robot_MembersInjector.create(factory)</span><br><span class="line">        injector.injectMembers(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在添加一个注入的成员变量 power：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Power</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> power: Power</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">val</span> controllerFactory = Controller_Factory.create()</span><br><span class="line">        <span class="keyword">val</span> powerFactory = Power_Factory.create()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> injector = Robot_MembersInjector.create(controllerFactory, powerFactory)</span><br><span class="line"></span><br><span class="line">        injector.injectMembers(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时应该祭出 Componet 了，我们来声明一个 AppComponet：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用 Component 来注入变量，Dagger 会根据 AppComponent 生成一个 DaggerAppComponent：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> power: Power</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        DaggerAppComponent.builder().build().inject(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来分析一下 DaggerAppComponent 的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerAppComponent</span> <span class="keyword">implements</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> MembersInjector&lt;Robot&gt; robotMembersInjector;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">DaggerAppComponent</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> builder != <span class="keyword">null</span>;</span><br><span class="line">    initialize(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder <span class="title">builder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Builder();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppComponent <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Builder().build();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.robotMembersInjector =</span><br><span class="line">        Robot_MembersInjector.create(Controller_Factory.create(), Power_Factory.create());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Robot robot)</span> </span>&#123;</span><br><span class="line">    robotMembersInjector.injectMembers(robot);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AppComponent <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DaggerAppComponent(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DaggerAppComponent 为我们构造了 Robot_MembersInjector ，在 <em>public void inject(Robot robot)</em> 调用了 <em>injectMembers</em> 方法，如果我们把 Robot 的代码复制一遍，新建一个 Robot2 类，AppComponet 修改为： </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot</span>)</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot2</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DaggerAppComponent 有什么变化呢？它会多一个 <em>robot2MembersInjector</em> 成员变量，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.robotMembersInjector =</span><br><span class="line">    Robot_MembersInjector.create(Controller_Factory.create(), Power_Factory.create());</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.robot2MembersInjector =</span><br><span class="line">    Robot2_MembersInjector.create(Controller_Factory.create(), Power_Factory.create());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Robot robot)</span> </span>&#123;</span><br><span class="line">robotMembersInjector.injectMembers(robot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Robot2 robot)</span> </span>&#123;</span><br><span class="line">robot2MembersInjector.injectMembers(robot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同理，在 Componet 添加多个 inject，会生成对应的 MembersInjector。现在我们注入的 Power 和 Controller 是不是单例的呢？不是的。来看 Robot_MembersInjector 的 injectMembers 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(Robot instance)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Cannot inject members into a null reference&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">instance.controller = controllerProvider.get();</span><br><span class="line">instance.power = powerProvider.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的 MembersInjector 的 get 方法都是 new 出一个对象。现在我们想把 Power 注入变成单例的，先加个 <em>@Singleton</em>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Power</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()</span><br></pre></td></tr></table></figure>
<p>编译一下，报错了…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error:(11, 2) 错误: com.sw926.dagger2example.AppComponent (unscoped) may not reference scoped bindings:</span><br><span class="line">@dagger.Component()</span><br><span class="line">^</span><br><span class="line">      @Singleton class com.sw926.dagger2example.Power</span><br></pre></td></tr></table></figure>
<p>Component 是连接 Provider 和 Injector 的桥梁，<em>@Singleton</em> 是作用域，不在一个域看来不让连接，那么给 Component 也加上注解：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译通过了，再来看 DaggerAppComponent 的源码，powerProvider 部分改变了，变成了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.powerProvider = DoubleCheck.provider(Power_Factory.create());</span><br></pre></td></tr></table></figure>
<p>DoubleCheck 的源码不用贴了，作用就是能保证 Provider get 的时候返回的是单例，而且是安全的，而是是懒加载的，很完美。</p>
<p>作为一个严谨的程序，一个 Power 哪里够用，我们需要一个备用的，也就是说，需要两个单例的 Power，现在 Module 要登场了。Module 是构造方法的仓库，我们把 Power 的注解去掉，改为在 Module 中提供构造方法，然后在 Component 中指定 Module</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Power</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">providePower</span><span class="params">()</span></span> = Power()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component(modules = [(AppModule::class)</span>])</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在添加一个 BackUp Power</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Power</span></span>(<span class="keyword">val</span> name: String)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加一个 BackUp 注解</span></span><br><span class="line"><span class="meta">@Qualifier</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BackUp &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">providePower</span><span class="params">()</span></span>: Power = Power(<span class="string">&quot;main&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BackUp</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">provideBackUpPower</span><span class="params">()</span></span>: Power = Power(<span class="string">&quot;backup&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> power: Power</span><br><span class="line">    <span class="meta">@field:</span>[Inject BackUp] <span class="keyword">lateinit</span> <span class="keyword">var</span> backUpPower: Power</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        DaggerAppComponent.builder().build().inject(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在注入 Power的时候，默认是 <em>main</em>, 如果添加了 @BackUp 注解，就是 <em>backup</em>，Robot_MembersInjector 会有三个 Provider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(Robot instance)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Cannot inject members into a null reference&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  instance.controller = controllerProvider.get();</span><br><span class="line">  instance.power = powerProvider.get();</span><br><span class="line">  instance.backUpPower = backUpPowerProvider.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是时候来验证一下是否是单例了，我们来创建两个 Robot ，看他们的 Power 和 BackUpPower 是否一样：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> robot1 = Robot()</span><br><span class="line"><span class="keyword">val</span> robot2 = Robot()</span><br><span class="line"></span><br><span class="line">Log.d(<span class="string">&quot;Dagger2Test&quot;</span>, <span class="string">&quot;robot1 :(<span class="subst">$&#123;robot1.power&#125;</span>, <span class="subst">$&#123;robot1.backUpPower&#125;</span>), \nrobot2: (<span class="subst">$&#123;robot2.power&#125;</span>, <span class="subst">$&#123;robot2.backUpPower&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">robot1 :(com.sw926.dagger2example.Power@5f1ad48, com.sw926.dagger2example.Power@862e7e1), </span><br><span class="line">robot2: (com.sw926.dagger2example.Power@dc97906, com.sw926.dagger2example.Power@24c8bc7</span><br></pre></td></tr></table></figure>
<p>说好的单例呢，怎么能骗人呢？大神们当然不会骗人，那肯定是我们的使用方式不对了，我们再来看看代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">providePower</span><span class="params">()</span></span>: Power = Power(<span class="string">&quot;main&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component(modules = [(AppModule::class)</span>])</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把注入分为三个部分：</p>
<ul>
<li>提供者（Provider）</li>
<li>接受者，Robot 中的成员变量 power</li>
<li>提供者和接受者直接的桥梁、纽带，也就 AppComponent</li>
</ul>
<p>Dagger 中，使用 Scope 注解的 Provider 提供的对象在作用域内唯一，这个唯一性由谁来控制呢？当然是 Component，每个 Component 只能确保自己注入时的作用域唯一，上面的例子每个 Robot 都创建了一个 AppComponent，所以注入的对象不相同，如果我们把 AppComponent 放在 Application 中创建，<br>那么注入的对象就是全局唯一对象了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> : <span class="type">Application</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">lateinit</span> <span class="keyword">var</span> appComponent: AppComponent</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        appComponent = DaggerAppComponent.builder().build()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> power: Power</span><br><span class="line">    <span class="meta">@field:</span>[Inject BackUp] <span class="keyword">lateinit</span> <span class="keyword">var</span> backUpPower: Power</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        App.appComponent.inject(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">robot1 :(com.sw926.dagger2example.Power@862e7e1, com.sw926.dagger2example.Power@dc97906), </span><br><span class="line">robot2: (com.sw926.dagger2example.Power@862e7e1, com.sw926.dagger2example.Power@dc97906</span><br></pre></td></tr></table></figure>
<p>如果同一个作用域内希望获取两个 Power，那么必须要起个名字区分一下，Qualifier 就是用来区别作用域内的两个对象，我们也可以用 @Named，相当于为第二个 Power起了一个名字：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">providePower</span><span class="params">()</span></span>: Power = Power(<span class="string">&quot;main&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(<span class="meta-string">&quot;backup&quot;</span>)</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">provideBackUpPower</span><span class="params">()</span></span>: Power = Power(<span class="string">&quot;backup&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Robot</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> controller: Controller</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> power: Power</span><br><span class="line">    <span class="meta">@field:</span>[Inject Named(<span class="string">&quot;backup&quot;</span>)] <span class="keyword">lateinit</span> <span class="keyword">var</span> backUpPower: Power</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        App.appComponent.inject(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们有了一个全局的 AppComponent，放在 Application 里面，管理 App 全局唯一的对象，现在我想有一个 Activity 生命周期的 Component，放在 每个 Activity 里面，Activity 的生命周期肯定在 App 的声明周期里面，所以 ActivityComponent 需要能够注入 AppComponent 注入的对象，现在 AppComponent 能够注入 Power BackUpPower，那么 ActivityComponent 也需要能够注入，这是需要用到 dependencies：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ForActivity</span></span><br><span class="line"><span class="meta">@Component(dependencies = [(AppComponent::class)</span>], modules = [(ActivityModule::<span class="class"><span class="keyword">class</span>)])</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ActivityComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(mainActivity: <span class="type">MainActivity</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们为 ActivityComponent 设置了一个作用域 @ForActivity，ActivityComponent 依赖于 AppComponent，现在来看看这样做有什么用。</p>
<p>注入一个对象需要一个 Provider，Provider 有以下几种形式：</p>
<ul>
<li>指定类的构造函数<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="meta">@Inject</span> <span class="keyword">constructor</span></span>()</span><br></pre></td></tr></table></figure></li>
<li>使用 Provider 函数<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">providePower</span><span class="params">()</span></span>: Power = Power(<span class="string">&quot;main&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li>从 dependencies 读取</li>
</ul>
<p>前两种不用说了，来说说第三种，ActivityComponent 的 module 是 ActivityModule</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ForActivity</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">providePowerName</span><span class="params">(<span class="meta">@Named(<span class="meta-string">&quot;backup&quot;</span>)</span> power: <span class="type">Power</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> power.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <em>providePowerName</em> 需要参数 <em>@Named(“backup”) power: Power</em>，这个 power 哪里找？当然是 Dagger 帮我们找，Provider 的三种形式，第一种没有，ActivityModule 里面没有，AppModule 里面有，但是怎么建立连接呢，很简单，在 AppComponent 写一个函数就行</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component(modules = [(AppModule::class)</span>])</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(robot: <span class="type">Robot</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Named(<span class="meta-string">&quot;backup&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getBackUpPower</span><span class="params">()</span></span>: Power</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么写一个函数就行，源码我也没看过，就当做这是 Dagger 的协议吧，编译后会生成对应的函数</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Power getBackUpPower() &#123;</span><br><span class="line">  <span class="keyword">return</span> provideBackUpPowerProvider.<span class="keyword">get</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在 ActivityComponent 的 module ActivityModule 找到了对应的 Provider，就可以正常提供 Power Name 了。</p>
<p>有了 AppComponent、ActivityComponent，下面就要添加 FragmentComponent了，Fragment 依赖于 Activity，那么我们这样做，FragmentComponent 只能由 ActivityComponent 创建，这就要用到 SubComponent，FragmentComponent 使用 @Subcomponent 注解，同时必须注明一个 Builder：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ForFragment</span></span><br><span class="line"><span class="meta">@Subcomponent(modules = [(FragmentModule::class)</span>])</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">FragmentComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">build</span><span class="params">()</span></span>: FragmentComponent</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ActivityComponent 改写为：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ForActivity</span></span><br><span class="line"><span class="meta">@Component(dependencies = [(AppComponent::class)</span>], modules = [(ActivityModule::<span class="class"><span class="keyword">class</span>)])</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ActivityComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(mainActivity: <span class="type">MainActivity</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fragmentComponent</span><span class="params">()</span></span>: FragmentComponent.Builder</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ActivityModule 里面指明 subcomponents ：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module(subcomponents = [(FragmentComponent::class)</span>])</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ForActivity</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">providePowerName</span><span class="params">(<span class="meta">@Named(<span class="meta-string">&quot;backup&quot;</span>)</span> power: <span class="type">Power</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> power.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译完成之后我们就可以使用 ActivityComponent 创建一个 FragmentComponent 了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> activityComponent = DaggerActivityComponent.builder().appComponent(App.appComponent).build()</span><br><span class="line">activityComponent.inject(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> fragmentComponent = activityComponent.fragmentComponent().build()</span><br></pre></td></tr></table></figure>
<p>最后说一下 Module 的 includes，也就是一个 Module 可以包含一组 Module</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityModule2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">provideException</span><span class="params">()</span></span>: Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> Exception(<span class="string">&quot;test Exception &quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module(subcomponents = [(FragmentComponent::class)</span>], includes = [(ActivityModule2::<span class="class"><span class="keyword">class</span>)])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ForActivity</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">providePowerName</span><span class="params">(<span class="meta">@Named(<span class="meta-string">&quot;backup&quot;</span>)</span> power: <span class="type">Power</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> power.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> exception: Exception</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> activityComponent = DaggerActivityComponent.builder().appComponent(App.appComponent).build()</span><br><span class="line">        activityComponent.inject(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;Dagger2Test&quot;</span>, <span class="string">&quot;Exception: <span class="variable">$exception</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D/Dagger2Test: Exception: java.lang.Exception: test Exception </span><br></pre></td></tr></table></figure>
<p>以上，使用 Dagger 好几年了，终于把思路理的比较清晰了，在此抛砖引玉，如果错误，欢迎指正。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://sw926.com/2016/11/08/ConstraintLayout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sunwei">
      <meta itemprop="description" content="不忘初心，方得始终">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小宇宙">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/08/ConstraintLayout/" class="post-title-link" itemprop="url">ConstraintLayout（约束布局）笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-08 14:15:59" itemprop="dateCreated datePublished" datetime="2016-11-08T14:15:59+08:00">2016-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-06 18:47:15" itemprop="dateModified" datetime="2020-04-06T18:47:15+08:00">2020-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="相对位置"><a href="#相对位置" class="headerlink" title="相对位置"></a>相对位置</h2><p>类似于RelativeLayout<br>横轴（Horizontal Axis） Left, Right, Start, End<br>竖轴（Vertical Axis）Top, Bottom, Text Baseline<br>可用的属性有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">layout_constraintLeft_toLeftOf</span><br><span class="line">layout_constraintLeft_toRightOf</span><br><span class="line">layout_constraintRight_toLeftOf</span><br><span class="line">layout_constraintRight_toRightOf</span><br><span class="line">layout_constraintTop_toTopOf</span><br><span class="line">layout_constraintTop_toBottomOf</span><br><span class="line">layout_constraintBottom_toTopOf</span><br><span class="line">layout_constraintBottom_toBottomOf</span><br><span class="line">layout_constraintBaseline_toBaselineOf</span><br><span class="line">layout_constraintStart_toEndOf</span><br><span class="line">layout_constraintStart_toStartOf</span><br><span class="line">layout_constraintEnd_toStartOf</span><br><span class="line">layout_constraintEnd_toEndOf</span><br></pre></td></tr></table></figure>
<h2 id="Margins-边距"><a href="#Margins-边距" class="headerlink" title="Margins(边距)"></a>Margins(边距)</h2><p>提供View.GONE时的间距</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">layout_goneMarginStart</span><br><span class="line">layout_goneMarginEnd</span><br><span class="line">layout_goneMarginLeft</span><br><span class="line">layout_goneMarginTop</span><br><span class="line">layout_goneMarginRight</span><br><span class="line">layout_goneMarginBottom</span><br></pre></td></tr></table></figure>
<h2 id="居中和偏差"><a href="#居中和偏差" class="headerlink" title="居中和偏差"></a>居中和偏差</h2><p>设置好位置后默认是居中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout ...&gt;</span><br><span class="line">             &lt;Button android:id&#x3D;&quot;@+id&#x2F;button&quot; ...</span><br><span class="line">                 app:layout_constraintLeft_toLeftOf&#x3D;&quot;parent&quot;</span><br><span class="line">                 app:layout_constraintRight_toRightOf&#x3D;&quot;parent&#x2F;&gt;</span><br><span class="line">         &lt;&#x2F;&gt;</span><br></pre></td></tr></table></figure>
<h2 id="偏差（Bias）"><a href="#偏差（Bias）" class="headerlink" title="偏差（Bias）"></a>偏差（Bias）</h2><p>默认是居中的可以使用一下两个参数调整</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">layout_constraintHorizontal_bias</span><br><span class="line">layout_constraintVertical_bias</span><br></pre></td></tr></table></figure>
<p>例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;android.support.constraint.ConstraintLayout ...&gt;</span><br><span class="line">             &lt;Button android:id&#x3D;&quot;@+id&#x2F;button&quot; ...</span><br><span class="line">                 app:layout_constraintHorizontal_bias&#x3D;&quot;0.3&quot;</span><br><span class="line">                 app:layout_constraintLeft_toLeftOf&#x3D;&quot;parent&quot;</span><br><span class="line">                 app:layout_constraintRight_toRightOf&#x3D;&quot;parent&#x2F;&gt;</span><br><span class="line">         &lt;&#x2F;&gt;</span><br></pre></td></tr></table></figure>
<h2 id="可见行为（Visibility-behavior）"><a href="#可见行为（Visibility-behavior）" class="headerlink" title="可见行为（Visibility behavior）"></a>可见行为（Visibility behavior）</h2><p>GONE控件在一般情况下不会显示和占用布局空间，但是他们的尺寸是保留的</p>
<ul>
<li>但是在计算布局时，GONE控件会计算在内</li>
<li>如果有其他控件被GONE的控件约束，这种约束仍然存在，但是所有的margins都会变为0</li>
<li>如果想保留margins，使用layout_goneMargin*属性<h2 id="尺寸约束（Dimensions-constraints）"><a href="#尺寸约束（Dimensions-constraints）" class="headerlink" title="尺寸约束（Dimensions constraints）"></a>尺寸约束（Dimensions constraints）</h2><h3 id="最小尺寸约束"><a href="#最小尺寸约束" class="headerlink" title="最小尺寸约束"></a>最小尺寸约束</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:minWidth</span><br><span class="line">android:minHeight</span><br></pre></td></tr></table></figure>
在WRAP_CONTENT是有效<h3 id="空间尺寸约束"><a href="#空间尺寸约束" class="headerlink" title="空间尺寸约束"></a>空间尺寸约束</h3>对于androdi:layout_width和android:layout_height有三种方式</li>
<li>使用一个固定的尺寸，例如123dp</li>
<li>使用WRAP_CONTENT</li>
<li>使用0dp, 相当于MATCH_CONSTRAINT</li>
<li><em>MATCH_PARENT不支持约束布局！！！*</em><br>MATCH_CONSTRAINT的left/right top/bottom设置为parent</li>
</ul>
<h2 id="比例（Ratio）"><a href="#比例（Ratio）" class="headerlink" title="比例（Ratio）"></a>比例（Ratio）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button android:layout_width&#x3D;&quot;wrap_content&quot;</span><br><span class="line">                  android:layout_height&#x3D;&quot;0dp&quot;</span><br><span class="line">                  app:layout_constraintDimensionRatio&#x3D;&quot;1:1&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
<p>值可以是一个float，页可以是“width:height”的形式<br>也可以把宽和高都设为MATCH_CONSTRAINT (0dp)，设置在Ratio的时候添加“W”或“H”以适应宽度活高度<br>例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Button android:layout_width&#x3D;&quot;0dp&quot;</span><br><span class="line">                   android:layout_height&#x3D;&quot;0dp&quot;</span><br><span class="line">                   app:layout_constraintDimensionRatio&#x3D;&quot;H,16:9&quot;</span><br><span class="line">                   app:layout_constraintBottom_toBottomOf&#x3D;&quot;parent&quot;</span><br><span class="line">                   app:layout_constraintTop_toTopOf&#x3D;&quot;parent&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>
<p>按钮的比例是16:9，宽度会匹配parent的约束</p>
<h2 id="链（Chains）"><a href="#链（Chains）" class="headerlink" title="链（Chains）"></a>链（Chains）</h2><p>比较难理解，简单的认为是一组控件在横轴或纵轴首尾相连，就是一条链</p>
<h3 id="创建链"><a href="#创建链" class="headerlink" title="创建链"></a>创建链</h3><p>一组控件在一个方向，首尾的控件连接到parent，中间的控件双向连接，如下图<br><img src="/images/chains.png" alt="chains"></p>
<h3 id="Chain-Header"><a href="#Chain-Header" class="headerlink" title="Chain Header"></a>Chain Header</h3><p>链被第一个控件控制，也就是最左边或者最顶端的</p>
<h3 id="Margins-in-chains"><a href="#Margins-in-chains" class="headerlink" title="Margins in chains"></a>Margins in chains</h3><p>如果在连接上指定边距，会计算这些边距。在spread chains中，边距会从分配的控件中扣除</p>
<h3 id="Chain-Style"><a href="#Chain-Style" class="headerlink" title="Chain Style"></a>Chain Style</h3><p>为header设置layout_constraintHorizontal_chainStyle或者layout_constraintVertical_chainStyle</p>
<ul>
<li>CHAIN_SPREAD – 元素将被展开</li>
<li>Weighted chain – 在 CHAIN_SPREAD 模式, 如果有控件为MATCH_CONSTRAINT，这个控件会占据所有可用的空间</li>
<li>CHAIN_SPREAD_INSIDE – 两端不会分配空间</li>
<li>CHAIN_PACKED – 所有元素打包在一起，空间分配到两端<br><img src="/images/chains-styles.png" alt="chains"><h3 id="Weighted-chains"><a href="#Weighted-chains" class="headerlink" title="Weighted chains"></a>Weighted chains</h3>spreed chain默认所有元素占据他们所需的空间，如果有元素为MATCH_CONSTRAINT，他们会使用所有的空白区域，使用layout_constraintHorizontal_weight和layout_constraintVertical_weight可用控制他们的比例。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sunwei</p>
  <div class="site-description" itemprop="description">不忘初心，方得始终</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">57</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sunwei</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
