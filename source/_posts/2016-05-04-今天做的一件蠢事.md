---
title: 今天做的一件蠢事，git reset --hard的恢复
date: 2016-05-04 18:23:54
category: Git
tags: 
    - Git
---
本来想把博客的工程传到github的gh-pages分支，所以
```sh
git init
git add --all
```
然后并没有进行commit，之后犯了一个错误，头脑发热执行了
```sh
git reset --hard
```
sublime sidebar一闪，工程目录空了，当时就蒙逼了...

马上Google，Google打不开，Shadowsocks也闹别扭了，百度一下，一屏的广告，果断关闭，bing...

还好已经add了，能够恢复，但是方法有点曲折:
找到最近的添加
```sh
$ find .git/objects -type f | xargs ls -lt | sed 5q
-r--r--r--  1 sunwei  staff   32393 May  4 18:31 .git/objects/00/29cb49889118b45b5ad762d8eb3f8f4ac26e87
-r--r--r--  1 sunwei  staff      83 May  4 18:31 .git/objects/04/8cdb0ecc50736bebe669ce7183269fd5dd8cfa
-r--r--r--  1 sunwei  staff      80 May  4 18:31 .git/objects/06/3b0e4ce79bbd23403f7e8ebfb71fb7779f869a
-r--r--r--  1 sunwei  staff    1093 May  4 18:31 .git/objects/07/872072704114b91681e2e6f9697ce1521b64d2
-r--r--r--  1 sunwei  staff     647 May  4 18:31 .git/objects/0f/951a9026a31df92690dcd2165b7c852fb27afa
```
然后
```sh
git cat-file -p {id} > {file}
```
id为
```
.git/objects/00/29cb49889118b45b5ad762d8eb3f8f4ac26e87
```
“.git/objects/”后面的字符串，去掉“/”
上面的id就是
```
0029cb49889118b45b5ad762d8eb3f8f4ac26e87
```
这个命令是把git object读取出来保存成文件
我是第一次add，有几百个文件，手工打命令肯定是不行了，写个脚本吧
首先把git objects保存到文件
```sh
find .git/objects -type f | xargs ls| sed >a.txt
```
新建一个r文件夹，写个ruby脚本
```ruby
i = 0
File.open("a.txt") do |file|
    file.each_line do |line|
        id = line[13,2] + line[16, 38]
        system 'git cat-file -p %s > ./r/%d.md' % [id, i]
        i = i + 1
    end
end
```
保存成recovery.ruby，执行
```sh
ruby recovery.ruby
```
所有的文件都会恢复到r文件夹，但是目录结构和名字是没有了，只能一个个找了。好在我只有19个post，几张图片，用下全局搜索，很快都找到了。
**得到一个教训，git reset --hard，git clean -df, rm -r, rm -rf慎用**
